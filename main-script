-- Загрузка Rayfield UI
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local scrVer = "0.4.3"

-- Создание окна
local Window = Rayfield:CreateWindow({
    Name = "Custom Aimbot",
    LoadingTitle = "Aimbot Loading",
    LoadingSubtitle = "by Sanya",
    ConfigurationSaving = {
        Enabled = false,
        FolderName = "UltraAimbot",
        FileName = "Config.json"
    },
    KeySystem = true,
    KeySettings = {
      Title = "Dead Rails Script.",
      Subtitle = "Enter Key To Get Access Of The Script.",
      Note = "Ask Me For Key.",
      FileName = "Key",
      SaveKey = true,
      GrabKeyFromSite = false,
      Key = {"q4F5YqeL"},
   },
})
 
-- Табы
local AimbotTab = Window:CreateTab("Aimbot", 4483362458)
local FullbrightTab = Window:CreateTab("Fullbright", 4483362458)
local UtilityTab = Window:CreateTab("Utility", 4483362458)
 
-- Настройки
local Settings = {
    Enabled = false,
    AimFOV = 120,
    MaxDistance = 500,
    Smoothing = 0.5,
    PriorityPart = "Head",
    Use3DDistance = true,
    IgnorePlayers = false,
    TeamCheck = false,
    WallCheck = false,
    AutoShoot = false,
    ShowFOV = true,
    FOVVisible = true,
    FOVFilled = false,
    fullbright = false,
    FOVThickness = 2,
    FOVColor = Color3.fromRGB(255, 255, 255),
    AimKey = Enum.KeyCode.E,
    ShootKey = Enum.KeyCode.F,
    RefreshRate = 0.2,
    Noclip = false,
}
 
-- Сервисы
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local MyCharacter = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
 
-- Переменные
local Aiming = false
local Shooting = false
local LockedTarget = nil
local MousePos = Vector2.new()
local LastMousePos = Vector2.new()
local FOV_Circle
local NPCList = {} -- Кэш для NPC
 
-- Инициализация FOV круга
local function InitializeFOV()
    if FOV_Circle then FOV_Circle:Remove() end
    FOV_Circle = Drawing.new("Circle")
    FOV_Circle.Transparency = 1
    FOV_Circle.Color = Settings.FOVColor
    FOV_Circle.Thickness = Settings.FOVThickness
    FOV_Circle.Filled = Settings.FOVFilled
    FOV_Circle.Visible = Settings.ShowFOV and Settings.FOVVisible
end
 
local function enableFullbright()
    Lighting.Ambient = Color3.new(1, 1, 1)
    Lighting.Brightness = 2
    Lighting.GlobalShadows = false
    Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
    for _, v in pairs(Lighting:GetChildren()) do
        if v:IsA("Atmosphere") then
            v:Destroy()
        end
    end
end
 
FullbrightTab:CreateToggle({
    Name = "Enable Fullbright",
    CurrentValue = false,
    Callback = function(Value)
        Settings.fullbright = Value
    end,
})
 
-- UI элементы
AimbotTab:CreateSection("Main")
AimbotTab:CreateToggle({Name = "Enable Aimbot", CurrentValue = Settings.Enabled, Callback = function(v) Settings.Enabled = v end})
AimbotTab:CreateToggle({Name = "Auto Shoot", CurrentValue = Settings.AutoShoot, Callback = function(v) Settings.AutoShoot = v end})
 
AimbotTab:CreateSection("Targeting")
AimbotTab:CreateSlider({Name = "Aim FOV", Range = {50, 500}, Increment = 5, CurrentValue = Settings.AimFOV, Callback = function(v) Settings.AimFOV = v end})
AimbotTab:CreateSlider({Name = "Max Distance", Range = {100, 2000}, Increment = 50, CurrentValue = Settings.MaxDistance, Callback = function(v) Settings.MaxDistance = v end})
AimbotTab:CreateDropdown({Name = "Priority Part", Options = {"Head", "HumanoidRootPart", "UpperTorso"}, CurrentOption = Settings.PriorityPart, Callback = function(v) Settings.PriorityPart = v end})
AimbotTab:CreateSlider({Name = "Smoothing", Range = {0.1, 1}, Increment = 0.05, CurrentValue = Settings.Smoothing, Callback = function(v) Settings.Smoothing = v end})
AimbotTab:CreateToggle({Name = "Ignore Players", CurrentValue = Settings.IgnorePlayers, Callback = function(v) Settings.IgnorePlayers = v end})
 
AimbotTab:CreateSection("FOV Circle")
AimbotTab:CreateToggle({Name = "Show FOV", CurrentValue = Settings.ShowFOV, Callback = function(v) Settings.ShowFOV = v FOV_Circle.Visible = v and Settings.FOVVisible end})
AimbotTab:CreateToggle({Name = "FOV Filled", CurrentValue = Settings.FOVFilled, Callback = function(v) Settings.FOVFilled = v FOV_Circle.Filled = v end})
AimbotTab:CreateSlider({Name = "FOV Thickness", Range = {1, 10}, Increment = 1, CurrentValue = Settings.FOVThickness, Callback = function(v) Settings.FOVThickness = v FOV_Circle.Thickness = v end})
AimbotTab:CreateColorPicker({Name = "FOV Color", Color = Settings.FOVColor, Callback = function(c) Settings.FOVColor = c FOV_Circle.Color = c end})

UtilityTab:CreateSection("Noclip")
UtilityTab:CreateToggle({
    Name = "Enable Noclip", 
    CurrentValue = Settings.Noclip, 
    Callback = function(v) 
        Settings.Noclip = v 
    end
})

-- Проверка валидности цели (работает и для NPC, и для игроков)
local function IsValidTarget(model)
    if not model:IsA("Model") or model == MyCharacter then return false end

    local hum = model:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then return false end

    -- Если это игрок и включено игнорирование игроков
    local player = Players:GetPlayerFromCharacter(model)
    if Settings.IgnorePlayers and player then return false end

    return true
end

local function GetTargetPart(model)
    if not model or not model:IsA("Model") then return nil end

    local part = model:FindFirstChild(Settings.PriorityPart)
    if part and part:IsA("BasePart") then return part end

    -- Fallback для NPC
    local head = model:FindFirstChild("Head") or model:FindFirstChild("head")
    if head and head:IsA("BasePart") then return head end

    local torso = model:FindFirstChild("HumanoidRootPart") or 
                 model:FindFirstChild("UpperTorso") or 
                 model:FindFirstChild("Torso")
    if torso and torso:IsA("BasePart") then return torso end

    return nil
end

-- Обновление списка NPC
local function UpdateNPCList()
    NPCList = {}
    for _, model in ipairs(Workspace:GetDescendants()) do
        if model:IsA("Model") and model ~= MyCharacter then
            local hum = model:FindFirstChildOfClass("Humanoid")
            if hum and hum.Health > 0 then
                table.insert(NPCList, model)
            end
        end
    end
end

-- Периодическое обновление списка NPC
task.spawn(function()
    while true do
        UpdateNPCList()
        task.wait(5) -- Обновляем список каждые 5 секунд для оптимизации
    end
end)

-- Цикл поиска цели (оптимизированный)
task.spawn(function()
    while true do
        if Settings.Enabled and Aiming then
            local bestTarget, closestDist = nil, math.huge
            local myPos = MyCharacter:GetPivot().Position

            -- Проверяем NPC из кэша
            for _, model in ipairs(NPCList) do
                if not IsValidTarget(model) then continue end
                local part = GetTargetPart(model)
                if not part then continue end

                local dist3D = (part.Position - myPos).Magnitude
                if Settings.Use3DDistance and dist3D > Settings.MaxDistance then continue end

                local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if not onScreen then continue end

                local dist2D = (Vector2.new(screenPos.X, screenPos.Y) - MousePos).Magnitude
                if dist2D > Settings.AimFOV then continue end

                if dist2D < closestDist then
                    closestDist = dist2D
                    bestTarget = part
                end
            end

            -- Если не игнорируем игроков, проверяем их тоже
            if not Settings.IgnorePlayers then
                for _, player in ipairs(Players:GetPlayers()) do
                    if player == LocalPlayer then continue end
                    local model = player.Character
                    if not model or not IsValidTarget(model) then continue end
                    
                    local part = GetTargetPart(model)
                    if not part then continue end

                    local dist3D = (part.Position - myPos).Magnitude
                    if Settings.Use3DDistance and dist3D > Settings.MaxDistance then continue end

                    local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
                    if not onScreen then continue end

                    local dist2D = (Vector2.new(screenPos.X, screenPos.Y) - MousePos).Magnitude
                    if dist2D > Settings.AimFOV then continue end

                    if dist2D < closestDist then
                        closestDist = dist2D
                        bestTarget = part
                    end
                end
            end

            LockedTarget = bestTarget
        else
            LockedTarget = nil
        end

        task.wait(Settings.RefreshRate)
    end
end)

-- Цикл поворота камеры
RunService.RenderStepped:Connect(function()
    LastMousePos = MousePos
    MousePos = UserInputService:GetMouseLocation()
    
    -- Check if mouse moved significantly to stop aiming
    if Aiming and (MousePos - LastMousePos).Magnitude > 10 then
        Aiming = false
        LockedTarget = nil
    end
    
    if Settings.fullbright then
        enableFullbright()
    end
    
    if Settings.Noclip and MyCharacter then
        for _, part in pairs(MyCharacter:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide then
                part.CanCollide = false
            end
        end
    elseif MyCharacter then
        local head = MyCharacter:FindFirstChild("Head")
        local torso = MyCharacter:FindFirstChild("Torso") or MyCharacter:FindFirstChild("UpperTorso")
        if head then head.CanCollide = true end
        if torso then torso.CanCollide = true end
    end
    
    if FOV_Circle then
        FOV_Circle.Position = MousePos
        FOV_Circle.Radius = Settings.AimFOV
        FOV_Circle.Visible = Settings.ShowFOV and Settings.FOVVisible
    end

    if Settings.Enabled and LockedTarget and LockedTarget.Parent and Aiming then
        local camPos = Camera.CFrame.Position
        local direction = (LockedTarget.Position - camPos).Unit
        local smoothDirection = Camera.CFrame.LookVector:Lerp(direction, Settings.Smoothing)

        Camera.CFrame = CFrame.lookAt(camPos, camPos + smoothDirection)

        if Settings.AutoShoot and Shooting then
            mouse1press()
            task.wait(0.03)
            mouse1release()
        end
    end
end)

-- Обработка клавиш
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Settings.AimKey then
        Aiming = not Aiming
        if not Aiming then
            LockedTarget = nil
            if Settings.Enabled then
                Rayfield:Notify({
                    Title = "Aimbot",
                    Content = "Disabled",
                    Duration = 2,
                    Image = 4483362458
                })
            end
        else
            if Settings.Enabled then
                Rayfield:Notify({
                    Title = "Aimbot",
                    Content = "Enabled",
                    Duration = 2,
                    Image = 4483362458
                })
            end
        end
    end
    if input.KeyCode == Settings.ShootKey then
        Shooting = not Shooting
        Rayfield:Notify({
            Title = "AutoShoot",
            Content = Shooting and "Enabled" or "Disabled",
            Duration = 2,
            Image = 4483362458
        })
    end     
end)

InitializeFOV()
-- Уведомление
Rayfield:Notify({
    Title = "Script Loaded",
    Content = "Script Version: " .. scrVer,
    Duration = 5,
    Image = 4483362458
})
